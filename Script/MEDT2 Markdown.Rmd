---
title: "MEDT2 Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1.Load data, convert categorical variables to factors, rescale continuous variables and remove highly correlated variables.

```{}
library(plyr)
data<-read.csv("/Users/chloemacgregor/Documents/MEDT/MEDT2/Analysis/cleandata.csv")
data$score<-as.factor(data$score)
data$score <- factor(data$score,
        levels=c(1,0),
        labels=c("correct","incorrect"))
data$instrument <- as.factor(data$instrument)
data$instrument <- factor(data$instrument,
        levels=c(1,2,3,4),
        labels=c("flute","piano","violin","voice"))
data$temotion <- as.factor(data$temotion)
data$temotion <- factor(data$temotion,
        levels=c(1,2,3,4,5),
        labels=c("anger","fear","happy","sad","tender"))
data$cemotion <- as.factor(data$cemotion)
data$cemotion <- factor(data$cemotion,
        levels=c(1,2,3,4,5),
        labels=c("anger","fear","happy","sad","tender"))
data$melody <- as.factor(data$melody)
data$melody <- factor(data$melody,
        levels=c(1,2,3),
        labels=c("a","b","c"))
data$tbpm<-scale(data$tbpm)
data$cbpm<-scale(data$cbpm)
data<-subset(data,select=-c(tlengths,clengths))
```

## 2.Build random forest model to check relationships between variables.

```{}
library(party)
my_var <- c("score","temotion","cemotion",
           "instrument","tbpm","cbpm",
           "tlengths","clengths", "melody")
forest_dat <- data(c[,my_var])
forest_dat <- na.omit(forest_dat)

tree <- ctree(score ~ ., data = forest_dat)
plot(tree)
```

![Figure 1 Random Forest Diagram](/Users/chloemacgregor/Documents/MEDT/MEDT2/Analysis/diagrams/randomforestplot.png)
```{}
mycontrols <- cforest_unbiased(ntree = 100,
                               mtry = 3,
                               minsplit = 5)

set.seed(1612)

forest <- cforest(score ~ .,
                  data = forest_dat,
                  controls = mycontrols)

forest_pred <- predict(forest,
                       OOB = TRUE)


forest_pred<-as.numeric(forest_pred)
data$score<-as.numeric(data$score)
acc <- cor(forest_pred, data$score)^2
acc

[1] 0.02609917

myvarimp <- varimp(forest)
barplot(myvarimp[1:9], space = 0.20, xlim = c(0,0.04),
        names.arg = rownames(myvarimp)[1:9],
        horiz = TRUE,
        cex.names = 0.8,
        cex = 0.8,
        las = 1)
```

![Figure 1 Barchart illustrating Variable importance](/Users/chloemacgregor/Documents/MEDT/MEDT2/Analysis/diagrams/barchart.png)

##  3. Model building.

```{}
library(lme4)
library(psyphy)
data<-read.csv("/Users/chloemacgregor/Documents/MEDT/MEDT2/Analysis/cleandata.csv")
data$score<-as.factor(data$score)
data$instrument<-as.factor(data$instrument)
data$temotion<-as.factor(data$temotion)
data$cemotion<-as.factor(data$cemotion)
data$melody<-as.factor(data$melody)
data$tbpm<-scale(data$tbpm)
data$cbpm<-scale(data$cbpm)
data<-subset(data, select=-c(tlengths, clengths))
```

**MODEL 1 with all predictors and interactions **

```{}
m1<-glmer(score ~ instrument + melody+cbpm*tbpm + cemotion*temotion + cemotion:temotion:instrument +  cemotion:temotion:instrument:melody+ (1|p_no),  data = data,
            family = binomial)
```

FAILED TO CONVERGE

**MODEL 2: temotionxcemotion**

```{}
m2 <- glmer(score ~ temotion*cemotion+ (1|p_no),  data = data,
            family = binomial)
```

FAILED TO CONVERGE

**MODEL 3: cemotion**
```{}
m3<-glmer(score~cemotion +(1|p_no),  data = data,
            family = binomial)
```
BIC:17582
77%


**MODEL 4: temotion + cemotion**

```{}
m4<-glmer(score~cemotion+ temotion+(1|p_no),  data = data,
            family = binomial)
```
FAILED TO CONVERGE

**MODEL 5: cemotion +cbpm**
```{}
m5<-glmer(score~cemotion+ cbpm+(1|p_no),  data = data,
            family = binomial)
```            
FAILED TO CONVERGE


**MODEL 6: temotion**
```{}
m6<-glmer(score~temotion +(1|p_no),  data = data,
            family = binomial)
```
            
BIC: 17602
77%


## Combine emotion factors into temotion*cemotion to interaction variable 'tece'
```{r}

data1<-read.csv("/Users/chloemacgregor/Documents/MEDT/MEDT2/Analysis/cleandata.csv")
data1$tece<-paste(data1$temotion,data1$cemotion,sep="")
data1$tece<-as.factor(data1$tece)
```

## Build new model with combined factor
```{r}
library(lme4)

m8<-glmer(score~tece+(1|p_no),  data = data1,
            family = binomial)
```
FAILED TO CONVERGE


## Fit Model using brms instead

### Combine tbpm & cbpm ("tcbpm")
```{}
data1$tcbpm<-(data1$tbpm-data1$cbpm)
data1$tcbpm<-scale(data1$tcbpm)
```

### BModel 1: all variables
```{}
bm1<- brm(score ~ tece+melody+tcbpm+instrument+(1|p_no), data=data1, family=bernoulli())
summary(bm1)
waic(bm1)
```

### Bmodel 1 Output
```{}
Family: bernoulli 
  Links: mu = logit 
Formula: score ~ tece + melody + tcbpm + instrument + (1 | p_no) 
   Data: data1 (Number of observations: 16707) 
Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup samples = 4000

Group-Level Effects: 
~p_no (Number of levels: 621) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     0.79      0.04     0.73     0.86 1.00     1230     1970

Population-Level Effects: 
            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept       0.30      0.16    -0.01     0.61 1.00      904     1799
tece14          1.15      0.15     0.86     1.44 1.00      822     1799
tece15          0.74      0.13     0.48     0.98 1.00      769     1609
tece25          0.55      0.26     0.05     1.06 1.00     1018     1827
tece31          0.12      0.12    -0.11     0.35 1.00     1956     3121
tece32         -0.19      0.18    -0.54     0.16 1.00     1939     2719
tece34          1.03      0.15     0.71     1.33 1.00      853     1786
tece35          1.05      0.14     0.76     1.32 1.00      704     1420
tece41          1.23      0.15     0.94     1.51 1.00      835     1840
tece43          0.89      0.15     0.60     1.17 1.00      868     1780
tece45         -0.22      0.18    -0.57     0.12 1.00      668     1311
tece51          0.95      0.14     0.67     1.23 1.00      887     1829
tece52          0.34      0.25    -0.14     0.84 1.00      864     1859
tece53          1.11      0.15     0.82     1.39 1.00      744     1523
tece54          0.10      0.18    -0.24     0.45 1.00      693     1351
melodyb        -0.01      0.11    -0.22     0.20 1.00     1231     2191
melodyc        -0.54      0.06    -0.66    -0.42 1.00     2621     2608
tcbpm           0.21      0.07     0.07     0.34 1.00      924     2003
instrument2     0.44      0.11     0.21     0.66 1.00     2197     2578
instrument3     0.38      0.12     0.14     0.62 1.00     1839     2719
instrument4     0.96      0.10     0.75     1.16 1.00     2062     2315

Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).

Computed from 4000 by 16707 log-likelihood matrix

          Estimate    SE
elpd_waic  -8122.9  68.1
p_waic       432.3   5.0
waic       16245.8 136.2
```

### BModel 2: all variables plus guessing parameter
```{}
bm2<- brm(

  bf(score~ guess + (1 - guess - inatt) * inv_logit(eta),

     eta ~ 0+tece+melody+tcbpm+instrument+(1|p_no), guess ~ 1, inatt ~ 1, nl = TRUE),

  data = data1, family = bernoulli("identity"),

  prior = c(

    prior(normal(0, 5), nlpar = "eta"),

    prior(beta(1, 1), nlpar = "guess", lb = 0, ub = 0.5),

    prior(beta(1, 1), nlpar = "inatt", lb = 0, ub = 0.1)),

)
summary(bm2)
waic(bm2)
```

### BM2 Output

Warning: more iterations needed.

### Bmodel 3: 10000 iterations
```{}
bm3<- brm(

  bf(score~ guess + (1 - guess - inatt) * inv_logit(eta),

     eta ~ 0+tece+melody+tcbpm+instrument+(1|p_no), guess ~ 1, inatt ~ 1, nl = TRUE),

  data = data1, family = bernoulli("identity"),

  prior = c(

    prior(normal(0, 5), nlpar = "eta"),

    prior(beta(1, 1), nlpar = "guess", lb = 0, ub = 0.5),

    prior(beta(1, 1), nlpar = "inatt", lb = 0, ub = 0.1)),
    
    iter=10000

)

summary(bm3)
waic(bm3)
loo(bm3)
```

### BM3 Output
```{}
Family: bernoulli 
  Links: mu = identity 
Formula: score ~ guess + (1 - guess - inatt) * inv_logit(eta) 
         eta ~ 0 + tece + melody + tcbpm + instrument + (1 | p_no)
         guess ~ 1
         inatt ~ 1
   Data: data1 (Number of observations: 16707) 
Samples: 4 chains, each with iter = 10000; warmup = 5000; thin = 1;
         total post-warmup samples = 20000

Group-Level Effects: 
~p_no (Number of levels: 621) 
                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(eta_Intercept)     8.34      0.97     6.57    10.38 1.00     2401     4501

Population-Level Effects: 
                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
eta_tece13         -1.46      0.84    -3.11     0.18 1.00     2961     6089
eta_tece14          2.81      0.93     1.05     4.69 1.00     2630     6081
eta_tece15          1.48      0.91    -0.27     3.31 1.00     2522     5998
eta_tece25         -1.55      1.95    -6.52     1.54 1.00     3034     3654
eta_tece31         -1.40      0.80    -2.97     0.16 1.00     3064     6056
eta_tece32         -7.92      1.57   -11.14    -4.93 1.00     4552     9038
eta_tece34          2.99      0.96     1.17     4.96 1.00     2620     5673
eta_tece35          3.14      0.93     1.41     5.04 1.00     2362     5373
eta_tece41          4.32      0.97     2.53     6.31 1.00     2654     5544
eta_tece43          2.06      0.87     0.40     3.82 1.00     2817     6320
eta_tece45        -19.62      2.22   -24.30   -15.61 1.00     4258     8079
eta_tece51          2.50      0.89     0.81     4.33 1.00     2802     5641
eta_tece52         -7.13      1.73   -10.69    -3.88 1.00     5879     9700
eta_tece53          4.19      0.89     2.57     6.06 1.00     2321     4499
eta_tece54        -12.12      1.73   -15.69    -8.98 1.00     3914     8407
eta_melodyb         1.33      0.44     0.51     2.22 1.00     6789    10476
eta_melodyc        -6.06      0.68    -7.49    -4.80 1.00     3205     5284
eta_tcbpm           0.53      0.34    -0.15     1.22 1.00     6868    10292
eta_instrument2     2.60      0.59     1.48     3.81 1.00     4460     7649
eta_instrument3     3.43      0.64     2.21     4.75 1.00     4284     7673
eta_instrument4     6.65      0.79     5.17     8.27 1.00     3179     5924
guess_Intercept     0.50      0.00     0.50     0.50 1.00    17244     8605
inatt_Intercept     0.06      0.00     0.05     0.07 1.00     3598     8108


Computed from 20000 by 16707 log-likelihood matrix

         Estimate    SE
elpd_loo  -7777.2  69.2
p_loo       615.7  13.0
looic     15554.5 138.5
------
Monte Carlo SE of elpd_loo is NA.

Pareto k diagnostic values:
                         Count Pct.    Min. n_eff
(-Inf, 0.5]   (good)     12961 77.6%   128       
 (0.5, 0.7]   (ok)        1222  7.3%   1203      
   (0.7, 1]   (bad)       1130  6.8%   865       
   (1, Inf)   (very bad)  1394  8.3%   710       
See help('pareto-k-diagnostic') for details.
Warning message:
Found 2524 observations with a pareto_k > 0.7 in model 'bm5'. It is recommended to set 'moment_match = TRUE' in order to perform moment matching for problematic observations.
```

## Remove non-significant variables: 
tcbpm

```{}
data2<-subset(data1,tece!=13 & tece!=15 & tece!=25 & tece!=31)
data2<-subset(data2, select=c(1:12))
```

### BModel 4: Including only significant variables
```{}
bm4<- brm(

  bf(score~ guess + (1 - guess - inatt) * inv_logit(eta),

     eta ~ 0+tece+melody+instrument+(1|p_no), guess ~ 1, inatt ~ 1, nl = TRUE),

  data = data1, family = bernoulli("identity"),

  prior = c(

    prior(normal(0, 5), nlpar = "eta"),

    prior(beta(1, 1), nlpar = "guess", lb = 0, ub = 0.5),

    prior(beta(1, 1), nlpar = "inatt", lb = 0, ub = 0.1)),
    
    iter=15000

)

summary(bm4)
waic(bm4)
loo(bm4)
```

### BM4 Output
```{}
 Family: bernoulli 
  Links: mu = identity 
Formula: score ~ guess + (1 - guess - inatt) * inv_logit(eta) 
         eta ~ 0 + tece + melody + instrument + (1 | p_no)
         guess ~ 1
         inatt ~ 1
   Data: data1 (Number of observations: 16707) 
Samples: 4 chains, each with iter = 15000; warmup = 7500; thin = 1;
         total post-warmup samples = 30000

Group-Level Effects: 
~p_no (Number of levels: 621) 
                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(eta_Intercept)     6.44      0.91     4.81     8.37 1.00     2275     4983

Population-Level Effects: 
                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
eta_tece13          2.67      1.01     0.81     4.78 1.00     2854     6096
eta_tece14          5.82      1.10     3.83     8.13 1.00     2355     4657
eta_tece15          5.15      1.06     3.23     7.37 1.00     2331     4589
eta_tece25         -1.25      1.64    -4.81     1.59 1.00     4807    10926
eta_tece31          2.71      0.93     1.01     4.64 1.00     2931     6192
eta_tece32         -4.49      1.20    -7.01    -2.32 1.00     8558    15543
eta_tece34          6.21      1.18     4.08     8.68 1.00     2325     4622
eta_tece35          6.93      1.27     4.64     9.59 1.00     2148     4403
eta_tece41          6.33      1.13     4.27     8.69 1.00     2343     4824
eta_tece43          4.99      1.08     3.04     7.26 1.00     2503     5229
eta_tece45        -14.90      2.32   -19.94   -10.86 1.00     6985    14198
eta_tece51          5.09      1.04     3.22     7.27 1.00     2486     5010
eta_tece52         -4.74      1.40    -7.73    -2.19 1.00     9698    14045
eta_tece53          6.78      1.21     4.65     9.32 1.00     2233     4528
eta_tece54         -5.23      1.35    -8.06    -2.81 1.00     7405    12974
eta_melody         -3.18      0.45    -4.14    -2.37 1.00     2276     4385
eta_instrument      1.58      0.21     1.20     2.02 1.00     4069     9555
guess_Intercept     0.50      0.00     0.50     0.50 1.00    32782    15852
inatt_Intercept     0.06      0.00     0.05     0.07 1.00     3723     9786

Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).
```
